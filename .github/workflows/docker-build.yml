name: Build and Push Docker Images

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_NAME_SERVER: ${{ secrets.DOCKERHUB_USERNAME }}/journey-planner-server
  IMAGE_NAME_CLIENT: ${{ secrets.DOCKERHUB_USERNAME }}/journey-planner-client

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for Server
        id: meta-server
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME_SERVER }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Extract metadata for Client
        id: meta-client
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME_CLIENT }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Server image
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-server.outputs.tags }}
          labels: ${{ steps.meta-server.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Build and push Client image
        uses: docker/build-push-action@v5
        with:
          context: ./client
          file: ./client/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-client.outputs.tags }}
          labels: ${{ steps.meta-client.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Generate Docker Compose for Portainer
        run: |
          cat > docker-compose.portainer.yml << 'EOF'
          version: '3.8'
          
          services:
            journey-planner-db:
              image: postgres:17-alpine
              container_name: journey-planner-db
              environment:
                POSTGRES_DB: journey_planner
                POSTGRES_USER: ${DB_USER:-admin}
                POSTGRES_PASSWORD: ${DB_PASSWORD}
              volumes:
                - journey-db-data:/var/lib/postgresql/data
                - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
              ports:
                - "${DB_PORT:-5432}:5432"
              restart: unless-stopped
              networks:
                - journey-network

            journey-planner-server:
              image: ${{ env.IMAGE_NAME_SERVER }}:latest
              container_name: journey-planner-server
              environment:
                NODE_ENV: production
                PORT: 5001
                DB_HOST: journey-planner-db
                DB_PORT: 5432
                DB_NAME: journey_planner
                DB_USER: ${DB_USER:-admin}
                DB_PASSWORD: ${DB_PASSWORD}
                FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
              ports:
                - "${SERVER_PORT:-5001}:5001"
              depends_on:
                - journey-planner-db
              restart: unless-stopped
              networks:
                - journey-network

            journey-planner-client:
              image: ${{ env.IMAGE_NAME_CLIENT }}:latest
              container_name: journey-planner-client
              environment:
                VITE_API_URL: ${API_URL:-http://localhost:5001/api}
              ports:
                - "${CLIENT_PORT:-3000}:80"
              depends_on:
                - journey-planner-server
              restart: unless-stopped
              networks:
                - journey-network

          volumes:
            journey-db-data:
              driver: local

          networks:
            journey-network:
              driver: bridge
          EOF

      - name: Upload Docker Compose artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-compose-portainer
          path: docker-compose.portainer.yml
          retention-days: 90

      - name: Create deployment info
        run: |
          cat > PORTAINER_DEPLOY.md << 'EOF'
          # ðŸš€ Deploy to Portainer from Docker Hub

          ## Quick Deploy Steps:

          1. **Open Portainer** (e.g., http://raspberry-pi:9000)
          2. Go to **Stacks** â†’ **Add Stack**
          3. Name: `journey-planner`
          4. Choose **Repository** deployment method
          5. Enter repository URL: `https://github.com/${{ github.repository }}`
          6. Branch: `main`
          7. Compose file path: `docker-compose.portainer.yml`
          8. Add environment variables:
             - `DB_PASSWORD`: Your PostgreSQL password
             - `DB_USER`: admin (or custom)
             - `FRONTEND_URL`: http://your-domain.com
             - `API_URL`: http://your-domain.com/api
          9. Click **Deploy Stack**

          ## Alternative: Web Editor Method

          1. Download `docker-compose.portainer.yml` from Actions artifacts
          2. Open Portainer â†’ **Stacks** â†’ **Add Stack**
          3. Choose **Web Editor**
          4. Paste the content of `docker-compose.portainer.yml`
          5. Add environment variables (same as above)
          6. Click **Deploy Stack**

          ## Images Available:
          - Server: `${{ env.IMAGE_NAME_SERVER }}:latest`
          - Client: `${{ env.IMAGE_NAME_CLIENT }}:latest`

          ## Auto-Update Stack:
          When you push to `main` branch, new images are built automatically.
          In Portainer:
          1. Go to your stack
          2. Click **Pull and redeploy**
          3. It will fetch latest images from Docker Hub

          ## Nginx Reverse Proxy:
          Add to your Nginx config:
          ```nginx
          location /journey/ {
              proxy_pass http://localhost:5001/;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_cache_bypass $http_upgrade;
          }
          
          location /journey-app/ {
              proxy_pass http://localhost:3000/;
          }
          ```
          EOF

      - name: Upload deployment guide
        uses: actions/upload-artifact@v4
        with:
          name: portainer-deployment-guide
          path: PORTAINER_DEPLOY.md
          retention-days: 90

      - name: Summary
        run: |
          echo "### âœ… Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Images:**" >> $GITHUB_STEP_SUMMARY
          echo "- Server: \`${{ env.IMAGE_NAME_SERVER }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- Client: \`${{ env.IMAGE_NAME_CLIENT }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy to Portainer:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to Portainer â†’ Stacks â†’ Add Stack" >> $GITHUB_STEP_SUMMARY
          echo "2. Use Repository method with this repo" >> $GITHUB_STEP_SUMMARY
          echo "3. Point to \`docker-compose.portainer.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Add environment variables and deploy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ Download \`docker-compose.portainer.yml\` from Actions artifacts" >> $GITHUB_STEP_SUMMARY
