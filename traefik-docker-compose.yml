# Traefik Reverse Proxy - Multi-App Configuration
# Supports multiple applications with path-based routing
# Example: /journey, /smarthome, /nextcloud, etc.

version: '3.8'

networks:
  web:
    name: web
    driver: bridge

services:
  traefik:
    image: traefik:v3.1
    container_name: traefik
    restart: unless-stopped
    
    command:
      # Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=web"
      
      # Entrypoints (HTTP + HTTPS)
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      
      # Redirect HTTP → HTTPS (opcjonalne, odkomentuj jeśli chcesz wymuszać HTTPS)
      # - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      # - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      
      # API Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=false"  # Bezpieczny dostęp przez HTTPS
      
      # Access logs (opcjonalne, dla debugowania)
      - "--accesslog=true"
      - "--log.level=INFO"
      
      # TLS Configuration (Tailscale certificates)
      # Jeśli używasz Tailscale, certyfikaty są automatycznie zarządzane
      # Dla innych domen, dodaj certyfikaty ręcznie lub użyj Let's Encrypt
    
    ports:
      - "80:80"      # HTTP
      - "443:443"    # HTTPS
    
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Opcjonalnie: montuj katalog z certyfikatami TLS
      # - ./certs:/certs:ro
    
    networks:
      - web
    
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=web"
      
      # Traefik Dashboard → https://malina.tail384b18.ts.net/traefik
      - "traefik.http.routers.traefik-dashboard.rule=Host(`malina.tail384b18.ts.net`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls=true"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      
      # Basic Auth dla Dashboard (opcjonalne, zalecane w produkcji)
      # Wygeneruj hasło: htpasswd -nb admin yourpassword
      # - "traefik.http.routers.traefik-dashboard.middlewares=traefik-auth"
      # - "traefik.http.middlewares.traefik-auth.basicauth.users=admin:$$apr1$$hash$$here"

---

# ===========================================
# PRZYKŁAD: SmartHome App
# ===========================================
# Dodaj do swojego docker-compose.yml dla SmartHome:
#
# services:
#   smarthome:
#     image: your-smarthome-image
#     container_name: smarthome-app
#     networks:
#       - web
#     labels:
#       - "traefik.enable=true"
#       - "traefik.docker.network=web"
#       - "traefik.http.routers.smarthome.rule=Host(`malina.tail384b18.ts.net`) && PathPrefix(`/smarthome`)"
#       - "traefik.http.routers.smarthome.entrypoints=websecure"
#       - "traefik.http.routers.smarthome.tls=true"
#       - "traefik.http.services.smarthome.loadbalancer.server.port=5000"
#       - "traefik.http.middlewares.smarthome-strip.stripprefix.prefixes=/smarthome"
#       - "traefik.http.routers.smarthome.middlewares=smarthome-strip"

# ===========================================
# PRZYKŁAD: Nextcloud
# ===========================================
# services:
#   nextcloud:
#     image: nextcloud:latest
#     container_name: nextcloud
#     networks:
#       - web
#     labels:
#       - "traefik.enable=true"
#       - "traefik.docker.network=web"
#       - "traefik.http.routers.nextcloud.rule=Host(`malina.tail384b18.ts.net`) && PathPrefix(`/nextcloud`)"
#       - "traefik.http.routers.nextcloud.entrypoints=websecure"
#       - "traefik.http.routers.nextcloud.tls=true"
#       - "traefik.http.services.nextcloud.loadbalancer.server.port=80"

# ===========================================
# ROUTING TABLE (przykładowa struktura URL)
# ===========================================
# https://malina.tail384b18.ts.net/           → Landing page / default app
# https://malina.tail384b18.ts.net/journey    → Journey Planner (frontend)
# https://malina.tail384b18.ts.net/journey/api → Journey Planner (backend API)
# https://malina.tail384b18.ts.net/smarthome  → SmartHome app
# https://malina.tail384b18.ts.net/nextcloud  → Nextcloud
# https://malina.tail384b18.ts.net/traefik    → Traefik Dashboard
# https://malina.tail384b18.ts.net/dashboard  → Traefik Dashboard (alternatywny path)

# ===========================================
# DEPLOYMENT INSTRUCTIONS
# ===========================================
# 1. Start Traefik:
#    docker-compose -f traefik-docker-compose.yml up -d
#
# 2. Verify 'web' network exists:
#    docker network ls | grep web
#
# 3. Deploy Journey Planner (w Portainerze lub CLI):
#    docker-compose -f docker-compose.yml up -d
#
# 4. Check Traefik dashboard:
#    https://malina.tail384b18.ts.net/dashboard/
#
# 5. Test Journey Planner:
#    https://malina.tail384b18.ts.net/journey
